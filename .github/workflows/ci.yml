name: CI

on:
  push:
    branches: [main]
  pull_request:

jobs:
  compile:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - run: python -m compileall -q src main.py

  build:
    runs-on: ubuntu-latest
    needs: compile
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
      - id: image
        run: echo "image_name=ghcr.io/${GITHUB_REPOSITORY,,}" >> $GITHUB_OUTPUT
      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile
          push: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
          tags: |
            ${{ steps.image.outputs.image_name }}:latest
            ${{ steps.image.outputs.image_name }}:${{ github.sha }}

  deploy:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - id: image
        run: echo "image_name=ghcr.io/${GITHUB_REPOSITORY,,}:latest" >> $GITHUB_OUTPUT
      - uses: appleboy/ssh-action@v1.0.3
        env:
          IMAGE: ${{ steps.image.outputs.image_name }}
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          WEBAPP_URL: ${{ secrets.WEBAPP_URL }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          JWT_TTL_SECONDS: ${{ secrets.JWT_TTL_SECONDS }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          GHCR_USERNAME: ${{ secrets.GHCR_USERNAME }}
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT || 22 }}
          envs: IMAGE,BOT_TOKEN,WEBAPP_URL,JWT_SECRET,JWT_TTL_SECONDS,POSTGRES_DB,POSTGRES_USER,POSTGRES_PASSWORD,GHCR_USERNAME,GHCR_TOKEN
          script: |
            set -e
            if ! command -v docker >/dev/null 2>&1; then
              curl -fsSL https://get.docker.com | sudo sh
            fi
            DOCKER="docker"
            if ! docker ps >/dev/null 2>&1; then
              DOCKER="sudo docker"
            fi

            POSTGRES_DB="${POSTGRES_DB:-memorio}"
            POSTGRES_USER="${POSTGRES_USER:-postgres}"
            POSTGRES_PASSWORD="${POSTGRES_PASSWORD:-postgres}"
            JWT_TTL_SECONDS="${JWT_TTL_SECONDS:-86400}"

            $DOCKER login ghcr.io -u "$GHCR_USERNAME" -p "$GHCR_TOKEN"
            $DOCKER pull "$IMAGE"
            $DOCKER pull postgres:16

            $DOCKER network inspect memorio-net >/dev/null 2>&1 || $DOCKER network create memorio-net
            $DOCKER volume inspect memorio-pg >/dev/null 2>&1 || $DOCKER volume create memorio-pg

            $DOCKER rm -f memorio-db >/dev/null 2>&1 || true
            $DOCKER run -d --name memorio-db --restart unless-stopped \
              --network memorio-net \
              -e POSTGRES_DB="$POSTGRES_DB" \
              -e POSTGRES_USER="$POSTGRES_USER" \
              -e POSTGRES_PASSWORD="$POSTGRES_PASSWORD" \
              -v memorio-pg:/var/lib/postgresql/data \
              postgres:16

            for i in $(seq 1 30); do
              if $DOCKER exec memorio-db pg_isready -U "$POSTGRES_USER" >/dev/null 2>&1; then
                break
              fi
              sleep 1
            done

            $DOCKER rm -f memorio-app >/dev/null 2>&1 || true
            $DOCKER run -d --name memorio-app --restart unless-stopped \
              --network memorio-net \
              -p 8000:8000 \
              -e BOT_TOKEN="$BOT_TOKEN" \
              -e WEBAPP_URL="$WEBAPP_URL" \
              -e JWT_SECRET="$JWT_SECRET" \
              -e JWT_TTL_SECONDS="$JWT_TTL_SECONDS" \
              -e DATABASE_URL="postgresql+asyncpg://${POSTGRES_USER}:${POSTGRES_PASSWORD}@memorio-db:5432/${POSTGRES_DB}" \
              "$IMAGE"
